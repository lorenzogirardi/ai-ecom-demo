name: "OPS: Invalidate CloudFront Cache"

on:
  workflow_dispatch:
    inputs:
      paths:
        description: 'Paths to invalidate (comma-separated, e.g., /api/*,/)'
        required: false
        default: '/*'
      distribution:
        description: 'CloudFront Distribution'
        required: true
        default: 'production'
        type: choice
        options:
          - production

env:
  CLOUDFRONT_DISTRIBUTION_ID: E1UREM48VZYPQA

jobs:
  invalidate:
    name: Invalidate Cache
    runs-on: ubuntu-latest
    environment: production

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::170674040462:role/ecommerce-demo-github-actions
          aws-region: us-east-1

      - name: Parse paths
        id: paths
        run: |
          PATHS="${{ github.event.inputs.paths }}"
          echo "paths=$PATHS" >> $GITHUB_OUTPUT

      - name: Create CloudFront Invalidation
        id: invalidate
        run: |
          echo "Creating invalidation for paths: ${{ steps.paths.outputs.paths }}"
          IFS=',' read -ra PATH_ARRAY <<< "${{ steps.paths.outputs.paths }}"

          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "${PATH_ARRAY[@]}" \
            --query 'Invalidation.Id' \
            --output text)

          echo "Invalidation created: $INVALIDATION_ID"
          echo "invalidation_id=$INVALIDATION_ID" >> $GITHUB_OUTPUT

      - name: Wait for Invalidation to Complete
        run: |
          echo "Waiting for invalidation ${{ steps.invalidate.outputs.invalidation_id }} to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
            --id ${{ steps.invalidate.outputs.invalidation_id }}
          echo "Invalidation completed successfully!"

      - name: Summary
        run: |
          echo "## ðŸŒ CloudFront Cache Invalidation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Distribution ID | \`${{ env.CLOUDFRONT_DISTRIBUTION_ID }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Invalidation ID | \`${{ steps.invalidate.outputs.invalidation_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Paths | \`${{ steps.paths.outputs.paths }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
