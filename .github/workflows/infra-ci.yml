name: Infrastructure CI

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
    paths:
      - 'ecommerce-demo/infra/terraform/**'
      - 'ecommerce-demo/helm/**'
      - '.github/workflows/infra-ci.yml'
      - 'ecommerce-demo/.checkov.yaml'
      - 'ecommerce-demo/.tflint.hcl'
  pull_request:
    branches: [main, develop]
    paths:
      - 'ecommerce-demo/infra/terraform/**'
      - 'ecommerce-demo/helm/**'
      - '.github/workflows/infra-ci.yml'
      - 'ecommerce-demo/.checkov.yaml'
      - 'ecommerce-demo/.tflint.hcl'

permissions:
  contents: write
  security-events: write

jobs:
  # ============================================
  # Gitleaks - Secret Detection
  # ============================================
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_NOTIFY_USER_LIST: '@${{ github.actor }}'

  # ============================================
  # TFLint - Terraform Linting
  # ============================================
  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: "v0.50.3"

      - name: Init TFLint
        run: tflint --init
        working-directory: ecommerce-demo/infra/terraform/environments/demo/platform

      - name: Run TFLint on modules
        run: |
          for module in ecommerce-demo/infra/terraform/modules/*/; do
            echo "Linting $module..."
            tflint "$module" || true
          done

      - name: Run TFLint on platform layer
        run: tflint .
        working-directory: ecommerce-demo/infra/terraform/environments/demo/platform
        continue-on-error: true

      - name: Run TFLint on services layer
        run: tflint .
        working-directory: ecommerce-demo/infra/terraform/environments/demo/services
        continue-on-error: true

  # ============================================
  # Checkov - Security Scanning
  # ============================================
  checkov:
    name: Checkov Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov on Terraform
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ecommerce-demo/infra/terraform
          config_file: ecommerce-demo/.checkov.yaml
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,results.sarif
          soft_fail: true

      - name: Run Checkov on Helm
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ecommerce-demo/helm
          config_file: ecommerce-demo/.checkov.yaml
          framework: helm
          output_format: cli
          soft_fail: true

      - name: Upload Checkov SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
        continue-on-error: true

  # ============================================
  # Terraform Format (Auto-fix)
  # ============================================
  terraform-fmt:
    name: Terraform Format
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Terraform Format
        run: terraform fmt -recursive
        working-directory: ecommerce-demo/infra/terraform

      - name: Commit formatted files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style(terraform): auto-format with terraform fmt"
          file_pattern: "ecommerce-demo/infra/terraform/**/*.tf"

  # ============================================
  # Terraform Validate
  # ============================================
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    needs: [terraform-fmt]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        working-directory: ecommerce-demo/infra/terraform

      - name: Validate Modules
        run: |
          for module in ecommerce-demo/infra/terraform/modules/*/; do
            echo "Validating $module..."
            cd "$module"
            terraform init -backend=false
            terraform validate
            cd -
          done

  # ============================================
  # Helm Lint
  # ============================================
  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'

      - name: Lint Backend Chart
        run: helm lint ecommerce-demo/helm/backend

      - name: Lint Frontend Chart
        run: helm lint ecommerce-demo/helm/frontend

      - name: Template Backend Chart
        run: helm template backend ecommerce-demo/helm/backend -f ecommerce-demo/helm/backend/values-demo.yaml

      - name: Template Frontend Chart
        run: helm template frontend ecommerce-demo/helm/frontend -f ecommerce-demo/helm/frontend/values-demo.yaml
